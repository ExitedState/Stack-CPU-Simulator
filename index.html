<html>

<head>
    <title>Stack CPU Simulator (16-bit)</title>
    <script>
        let pc = 0;
        let ds = 32;
        let rs = 32;
        function Step() {
            const numRows = parseInt(document.getElementById("row-count-input").value)
            // fetch
            var ir = document.getElementById("mem" + pc).value;
            var operand = "";

            document.getElementById("pc" + pc).innerHTML = "&nbsp;";
            pc = (parseInt(pc) + 1) % numRows;
            document.getElementById("pc" + pc).innerHTML = "x";

            if (ir == "opcode13" || ir == "opcode14" || ir == "opcode16") { // IF, CALL, LIT

                operand = document.getElementById("mem" + pc).value;
                document.getElementById("pc" + pc).innerHTML = "&nbsp;";
                pc = (parseInt(pc) + 1) % numRows;
                document.getElementById("pc" + pc).innerHTML = "x";
            }
            // execute
            if (ir == "opcode0") { 				// !

                addr = parseInt(document.getElementById("ds" + ds).innerHTML, 16);
                document.getElementById("ds" + ds).innerHTML = "&nbsp;";
                ds = parseInt(ds) + 1;

                n1 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);
                document.getElementById("ds" + ds).innerHTML = "&nbsp;";
                ds = parseInt(ds) + 1;
                n1 = n1.toString(16).toUpperCase();
                document.getElementById("mem" + addr).value = n1.length == 1 ? "0" + n1 : n1;
                console.log("mem[" + addr + "] = " + (n1.toString(16)).toUpperCase());

            } else if (ir == "opcode1") {		// +

                n2 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);
                document.getElementById("ds" + ds).innerHTML = "&nbsp;";
                ds = parseInt(ds) + 1;

                n1 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);
                tmp = ((n1 + n2) & 0xffff).toString(16).toUpperCase();
                while (tmp.length < 4) tmp = "0" + tmp;
                document.getElementById("ds" + ds).innerHTML = tmp;

            } else if (ir == "opcode2") {		// -

                n2 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);
                document.getElementById("ds" + ds).innerHTML = "&nbsp;";
                ds = parseInt(ds) + 1;

                n1 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);
                tmp = ((n1 + ~n2 + 1) & 0xffff).toString(16).toUpperCase();
                while (tmp.length < 4) tmp = "0" + tmp;
                document.getElementById("ds" + ds).innerHTML = tmp;

            } else if (ir == "opcode3") {		// >R

                rs = parseInt(rs) - 1;
                document.getElementById("rs" + rs).innerHTML = document.getElementById("ds" + ds).innerHTML;
                document.getElementById("ds" + ds).innerHTML = "&nbsp;";
                ds = parseInt(ds) + 1;

            } else if (ir == "opcode4") {		// @

                addr = parseInt(document.getElementById("ds" + ds).innerHTML, 16);
                tmp = document.getElementById("mem" + addr).value;
                while (tmp.length < 4) tmp = "0" + tmp;
                document.getElementById("ds" + ds).innerHTML = tmp;

            } else if (ir == "opcode5") {		// AND

                n2 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);
                document.getElementById("ds" + ds).innerHTML = "&nbsp;";
                ds = parseInt(ds) + 1;

                n1 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);

                tmp = ((n1 & n2) & 0xffff).toString(16).toUpperCase();
                while (tmp.length < 4) tmp = "0" + tmp;
                document.getElementById("ds" + ds).innerHTML = tmp;

            } else if (ir == "opcode6") {		// DROP

                document.getElementById("ds" + ds).innerHTML = "&nbsp;";
                ds = parseInt(ds) + 1;

            } else if (ir == "opcode7") {		// DUP

                document.getElementById("ds" + (ds - 1)).innerHTML = document.getElementById("ds" + ds).innerHTML;
                ds = parseInt(ds) - 1;

            } else if (ir == "opcode8") {		// OR

                n2 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);
                document.getElementById("ds" + ds).innerHTML = "&nbsp;";
                ds = parseInt(ds) + 1;

                n1 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);

                tmp = ((n1 | n2) & 0xffff).toString(16).toUpperCase();
                while (tmp.length < 4) tmp = "0" + tmp;
                document.getElementById("ds" + ds).innerHTML = tmp;

            } else if (ir == "opcode9") {		// OVER

                document.getElementById("ds" + (ds - 1)).innerHTML = document.getElementById("ds" + (ds + 1)).innerHTML;
                ds = parseInt(ds) - 1;

            } else if (ir == "opcode10") {		// R>

                ds = parseInt(ds) - 1;
                document.getElementById("ds" + ds).innerHTML = document.getElementById("rs" + rs).innerHTML;
                document.getElementById("rs" + rs).innerHTML = "&nbsp;";
                rs = parseInt(rs) + 1;

            } else if (ir == "opcode11") {		// SWAP

                n1 = document.getElementById("ds" + ds).innerHTML;
                n2 = document.getElementById("ds" + (ds + 1)).innerHTML;
                document.getElementById("ds" + ds).innerHTML = n2;
                document.getElementById("ds" + (ds + 1)).innerHTML = n1;

            } else if (ir == "opcode12") {		// XOR

                n2 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);
                document.getElementById("ds" + ds).innerHTML = "&nbsp;";
                ds = parseInt(ds) + 1;

                n1 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);

                tmp = ((n1 ^ n2) & 0xffff).toString(16).toUpperCase();
                while (tmp.length < 4) tmp = "0" + tmp;
                document.getElementById("ds" + ds).innerHTML = tmp;

            } else if (ir == "opcode13") {		// IF

                n1 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);
                document.getElementById("ds" + ds).innerHTML = "&nbsp;";
                ds = parseInt(ds) + 1;

                if (n1 == 0) {
                    document.getElementById("pc" + pc).innerHTML = "&nbsp;";
                    pc = parseInt(operand, 16);
                    document.getElementById("pc" + pc).innerHTML = "x";
                }

            } else if (ir == "opcode14") {		// CALL

                rs = parseInt(rs) - 1;
                tmp = pc.toString(16);
                while (tmp.length < 4) tmp = "0" + tmp;
                document.getElementById("rs" + rs).innerHTML = tmp;
                document.getElementById("pc" + pc).innerHTML = "&nbsp;";
                pc = parseInt(operand, 16);
                document.getElementById("pc" + pc).innerHTML = "x";

            } else if (ir == "opcode15") {		// EXIT

                document.getElementById("pc" + pc).innerHTML = "&nbsp;";
                pc = parseInt(document.getElementById("rs" + rs).innerHTML, 16);
                document.getElementById("pc" + pc).innerHTML = "x";
                document.getElementById("rs" + rs).innerHTML = "&nbsp;";
                rs = parseInt(rs) + 1;

            } else if (ir == "opcode16") {		// LIT
                ds = parseInt(ds) - 1;
                tmp = parseInt(operand, 16).toString(16).toUpperCase();
                while (tmp.length < 4) tmp = "0" + tmp;
                document.getElementById("ds" + ds).innerHTML = tmp;

            } else if (ir == "opcode17") {		// HALT

                alert("Halt");

            } else {

                tmp = (pc - 1).toString(16).toUpperCase();
                while (tmp.length < 4) tmp = "0" + tmp;
                alert("Opcode is not found at address " + tmp);
            }
        }

        function Reset() {
            const numRows = parseInt(document.getElementById("row-count-input").value);
            pc = 0;
            ds = numRows;
            rs = ds;
            for (var i = 0; i < ds; i++) {
                document.getElementById("pc" + i).innerHTML = "&nbsp;";
                document.getElementById("ds" + i).innerHTML = "&nbsp;";
                document.getElementById("rs" + i).innerHTML = "&nbsp;";
            }
            document.getElementById("pc0").innerHTML = "x";
        }

        function ResetAndClearMem() {
            var confirmation = confirm("Are you sure you want to reset the memory?");
            if (confirmation) {
                Reset();
                for (var i = 0; i < ds; i++) {
                    var selectElement = document.getElementById("mem" + i);
                    selectElement.selectedIndex = 0; // Reset to the first option
                }
            }
        }

        function createMemorySelect(index) {
            let options = '';
            options += `<option value="opcode0">!</option>`;
            options += `<option value="opcode1">+</option>`;
            options += `<option value="opcode2">-</option>`;
            options += `<option value="opcode3">>R</option>`;
            options += `<option value="opcode4">@</option>`;
            options += `<option value="opcode5">AND</option>`;
            options += `<option value="opcode6">DROP</option>`;
            options += `<option value="opcode7">DUP</option>`;
            options += `<option value="opcode8">OR</option>`;
            options += `<option value="opcode9">OVER</option>`;
            options += `<option value="opcode10">R></option>`;
            options += `<option value="opcode11">SWAP</option>`;
            options += `<option value="opcode12">XOR</option>`;
            options += `<option value="opcode13">IF</option>`;
            options += `<option value="opcode14">CALL</option>`;
            options += `<option value="opcode15">EXIT</option>`;
            options += `<option value="opcode16">LIT</option>`;
            options += `<option value="opcode17">HALT</option>`;
            for (let i = -31; i <= -1; i++) {
                let hexValue = (0x10000 + i).toString(16).toUpperCase();
                options += `<option value="${hexValue}">x${hexValue} (${i})</option>`;
            }
            const hexValues = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'A', 'B', 'C', 'D', 'E', 'F'];
            for (let i = 0; i < hexValues.length; i++) {
                for (let j = 0; j < hexValues.length; j++) {
                    let value = hexValues[i] + hexValues[j];
                    let intValue = parseInt(value, 16);
                    if (intValue > 63) {
                        break;
                    }
                    let hex = `x00${value}`;
                    let description = `(+${intValue})`;
                    options += `<option value="${value}">${hex} ${description}</option>`;
                }
            }
            options += '<option value="8000">x8000 (mask)</option>';
            options += '<option value="000F">x000F (mask)</option>';
            options += '<option value="00F0">x00F0 (mask)</option>';
            options += '<option value="00FF">x00FF (mask)</option>';
            return `<select id="mem${index}">${options}</select>`;
        }

        function createTableRows(numRows) {
            let html = "";
            for (let i = 0; i < numRows; i++) {
                let hexValue = i.toString(16).toUpperCase().padStart(2, '0');
                html += `<tr>
                    <td align="center" width="35px"><span id="pc${i}">${i === 0 ? 'x' : '&nbsp;'}</span></td>
                    <td align="center" width="78px">x${hexValue}</td>
                    <td align="center" width="110px">${createMemorySelect(i)}</td>
                </tr>`;
            }
            return html;
        }

        function createStackRows(numRows, idPrefix) {
            let html = "";
            for (let i = 0; i < numRows; i++) {
                html += `<tr>
                    <td align="center"><span id="${idPrefix}${i}">&nbsp;</span></td>
                </tr>`;
            }
            return html;
        }

        function updateTableRows() {
            numRows = parseInt(document.getElementById("row-count-input").value) || ds;
            numRows = Math.max(5, Math.min(numRows, 64));
            document.getElementById("table-body").innerHTML = createTableRows(numRows);
            document.getElementById("data-stack-body").innerHTML = createStackRows(numRows, 'ds');
            document.getElementById("return-stack-body").innerHTML = createStackRows(numRows, 'rs');
            Reset();
        }

        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById("table-body").innerHTML = createTableRows(ds);
            document.getElementById("data-stack-body").innerHTML = createStackRows(ds, 'ds');
            document.getElementById("return-stack-body").innerHTML = createStackRows(ds, 'rs');
            Reset();
        });
    </script>
</head>

<body>
    <style>
        .scrollable {
            overflow-y: scroll;
            height: 75vh;
        }

        ::-webkit-scrollbar {
            width: 0px;
            height: 0px;
        }

        table {
            border-collapse: collapse;
        }

        tr:nth-child(odd) {
            background-color: #858484;
        }
    </style>
    <b>Stack CPU Simulator (16-bit)</b><br><br>
    Number of Address (5-64): <input type="number" id="row-count-input" value="32" min="5" max="64">
    <input type="button" value="Apply" onclick="updateTableRows()">
    <br><br>
    <div style="display: flex;">
        <div>
            <table border="1" cellspacing="1" cellpadding="5" bordercolor="black"
                style="position: sticky; top: 0; width: 100%;">
                <tr>
                    <td align="center" style="width:22px;">PC</td>
                    <td align="center" style="width:51px;">Address</td>
                    <td align="center" style="width:76px;">Memory</td>
                </tr>
            </table>
            <div class="scrollable">
                <table border="1" cellspacing="1" cellpadding="5" bordercolor="black" style="width: 100%;">
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
        <div>
            <table border="1" cellspacing="1" cellpadding="5" bordercolor="black"
                style="position: sticky; top: 0; width: 100%;">
                <tr>
                    <td align="center" style="width: 100%;">Data Stack</td>
                </tr>
            </table>
            <div class="scrollable">
                <table border="1" cellspacing="1" cellpadding="5" bordercolor="black" style="width: 100%;">
                    <tbody id="data-stack-body"></tbody>
                </table>
            </div>
        </div>
        <div>
            <table border="1" cellspacing="1" cellpadding="5" bordercolor="black"
                style="position: sticky; top: 1; width: 100%;">
                <tr>
                    <td align="center" style="width: 100%;">Return Stack</td>
                </tr>
            </table>
            <div class="scrollable">
                <table border="1" cellspacing="1" cellpadding="5" bordercolor="black" style="width: 100%;">
                    <tbody id="return-stack-body"></tbody>
                </table>
            </div>
        </div>
    </div>
    <br>
    <input type="button" value=" Step " onclick="Step()">
    <input type="button" value=" Reset " onclick="Reset()">
    <input type="button" value=" Reset and Clear Memory " onclick="ResetAndClearMem()">
</body>

</html>