<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=Windows-874">
    <title>Stack CPU Simulator (16-bit)</title>
    <script>
        let pc = 0;
        let ds = 32;
        let rs = 32;
        function Step() {
            const numRows = parseInt(document.getElementById("row-count-input").value)
            // fetch
            var ir = document.getElementById("mem" + pc).value;
            var operand = "";

            document.getElementById("pc" + pc).innerHTML = "&nbsp;";
            pc = (parseInt(pc) + 1) % numRows;
            document.getElementById("pc" + pc).innerHTML = "x";

            if (ir == "opcode13" || ir == "opcode14" || ir == "opcode16") { // IF, CALL, LIT

                operand = document.getElementById("mem" + pc).value;
                document.getElementById("pc" + pc).innerHTML = "&nbsp;";
                pc = (parseInt(pc) + 1) % numRows;
                document.getElementById("pc" + pc).innerHTML = "x";
            }
            // execute
            if (ir == "opcode0") { 				// !

                addr = parseInt(document.getElementById("ds" + ds).innerHTML, 16);
                document.getElementById("ds" + ds).innerHTML = "&nbsp;";
                ds = parseInt(ds) + 1;

                n1 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);
                document.getElementById("ds" + ds).innerHTML = "&nbsp;";
                ds = parseInt(ds) + 1;
                n1 = n1.toString(16).toUpperCase();
                document.getElementById("mem" + addr).value = n1.length == 1 ? "0" + n1 : n1;
                console.log("mem[" + addr + "] = " + (n1.toString(16)).toUpperCase());

            } else if (ir == "opcode1") {		// +

                n2 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);
                document.getElementById("ds" + ds).innerHTML = "&nbsp;";
                ds = parseInt(ds) + 1;

                n1 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);
                tmp = ((n1 + n2) & 0xffff).toString(16).toUpperCase();
                while (tmp.length < 4) tmp = "0" + tmp;
                document.getElementById("ds" + ds).innerHTML = tmp;

            } else if (ir == "opcode2") {		// -

                n2 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);
                document.getElementById("ds" + ds).innerHTML = "&nbsp;";
                ds = parseInt(ds) + 1;

                n1 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);
                tmp = ((n1 + ~n2 + 1) & 0xffff).toString(16).toUpperCase();
                while (tmp.length < 4) tmp = "0" + tmp;
                document.getElementById("ds" + ds).innerHTML = tmp;

            } else if (ir == "opcode3") {		// >R

                rs = parseInt(rs) - 1;
                document.getElementById("rs" + rs).innerHTML = document.getElementById("ds" + ds).innerHTML;
                document.getElementById("ds" + ds).innerHTML = "&nbsp;";
                ds = parseInt(ds) + 1;

            } else if (ir == "opcode4") {		// @

                addr = parseInt(document.getElementById("ds" + ds).innerHTML, 16);
                tmp = document.getElementById("mem" + addr).value;
                while (tmp.length < 4) tmp = "0" + tmp;
                document.getElementById("ds" + ds).innerHTML = tmp;

            } else if (ir == "opcode5") {		// AND

                n2 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);
                document.getElementById("ds" + ds).innerHTML = "&nbsp;";
                ds = parseInt(ds) + 1;

                n1 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);

                tmp = ((n1 & n2) & 0xffff).toString(16).toUpperCase();
                while (tmp.length < 4) tmp = "0" + tmp;
                document.getElementById("ds" + ds).innerHTML = tmp;

            } else if (ir == "opcode6") {		// DROP

                document.getElementById("ds" + ds).innerHTML = "&nbsp;";
                ds = parseInt(ds) + 1;

            } else if (ir == "opcode7") {		// DUP

                document.getElementById("ds" + (ds - 1)).innerHTML = document.getElementById("ds" + ds).innerHTML;
                ds = parseInt(ds) - 1;

            } else if (ir == "opcode8") {		// OR

                n2 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);
                document.getElementById("ds" + ds).innerHTML = "&nbsp;";
                ds = parseInt(ds) + 1;

                n1 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);

                tmp = ((n1 | n2) & 0xffff).toString(16).toUpperCase();
                while (tmp.length < 4) tmp = "0" + tmp;
                document.getElementById("ds" + ds).innerHTML = tmp;

            } else if (ir == "opcode9") {		// OVER

                document.getElementById("ds" + (ds - 1)).innerHTML = document.getElementById("ds" + (ds + 1)).innerHTML;
                ds = parseInt(ds) - 1;

            } else if (ir == "opcode10") {		// R>

                ds = parseInt(ds) - 1;
                document.getElementById("ds" + ds).innerHTML = document.getElementById("rs" + rs).innerHTML;
                document.getElementById("rs" + rs).innerHTML = "&nbsp;";
                rs = parseInt(rs) + 1;

            } else if (ir == "opcode11") {		// SWAP

                n1 = document.getElementById("ds" + ds).innerHTML;
                n2 = document.getElementById("ds" + (ds + 1)).innerHTML;
                document.getElementById("ds" + ds).innerHTML = n2;
                document.getElementById("ds" + (ds + 1)).innerHTML = n1;

            } else if (ir == "opcode12") {		// XOR

                n2 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);
                document.getElementById("ds" + ds).innerHTML = "&nbsp;";
                ds = parseInt(ds) + 1;

                n1 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);

                tmp = ((n1 ^ n2) & 0xffff).toString(16).toUpperCase();
                while (tmp.length < 4) tmp = "0" + tmp;
                document.getElementById("ds" + ds).innerHTML = tmp;

            } else if (ir == "opcode13") {		// IF

                n1 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);
                document.getElementById("ds" + ds).innerHTML = "&nbsp;";
                ds = parseInt(ds) + 1;

                if (n1 == 0) {
                    document.getElementById("pc" + pc).innerHTML = "&nbsp;";
                    pc = parseInt(operand, 16);
                    document.getElementById("pc" + pc).innerHTML = "x";
                }

            } else if (ir == "opcode14") {		// CALL

                rs = parseInt(rs) - 1;
                tmp = pc.toString(16);
                while (tmp.length < 4) tmp = "0" + tmp;
                document.getElementById("rs" + rs).innerHTML = tmp;
                document.getElementById("pc" + pc).innerHTML = "&nbsp;";
                pc = parseInt(operand, 16);
                document.getElementById("pc" + pc).innerHTML = "x";

            } else if (ir == "opcode15") {		// EXIT

                document.getElementById("pc" + pc).innerHTML = "&nbsp;";
                pc = parseInt(document.getElementById("rs" + rs).innerHTML, 16);
                document.getElementById("pc" + pc).innerHTML = "x";
                document.getElementById("rs" + rs).innerHTML = "&nbsp;";
                rs = parseInt(rs) + 1;

            } else if (ir == "opcode16") {		// LIT
                ds = parseInt(ds) - 1;
                tmp = parseInt(operand, 16).toString(16).toUpperCase();
                while (tmp.length < 4) tmp = "0" + tmp;
                document.getElementById("ds" + ds).innerHTML = tmp;

            } else if (ir == "opcode17") {		// HALT
                alert("Halt");
                Stop();
                return;
            } else {
                tmp = (pc - 1).toString(16).toUpperCase();
                while (tmp.length < 4) tmp = "0" + tmp;
                halt = true;
                Stop();
                alert("Opcode is not found at address " + tmp);
                return;
            }
        }
        function Run() {
            halt = false;
            document.getElementById("run-but").disabled = true;
            document.getElementById("step-but").disabled = true;
            document.getElementById("reset-but").disabled = true;
            document.getElementById("clear-but").disabled = true;
            document.getElementById("appply-but").disabled = true;
            document.getElementById("save-button").disabled = true;
            function executeNextStep() {
                try {
                    if (!halt) {
                        Step();
                        requestAnimationFrame(executeNextStep);
                    }
                } catch (error) {
                    Stop();
                    alert("Error occurred : please check your code");
                }
            }
            executeNextStep();
        }
        function Stop() {
            halt = true;
            document.getElementById("run-but").disabled = false;
            document.getElementById("step-but").disabled = false;
            document.getElementById("reset-but").disabled = false;
            document.getElementById("clear-but").disabled = false;
            document.getElementById("appply-but").disabled = false;
            document.getElementById("save-button").disabled = false;
        }



        function Reset() {
            const numRows = parseInt(document.getElementById("row-count-input").value);
            pc = 0;
            ds = numRows;
            rs = ds;
            for (var i = 0; i < ds; i++) {
                document.getElementById("pc" + i).innerHTML = "&nbsp;";
                document.getElementById("ds" + i).innerHTML = "&nbsp;";
                document.getElementById("rs" + i).innerHTML = "&nbsp;";
            }
            document.getElementById("pc0").innerHTML = "x";
        }

        function ResetAndClearMem() {
            var confirmation = confirm("Are you sure you want to reset the memory?");
            if (confirmation) {
                Reset();
                localStorage.clear();
                for (var i = 0; i < ds; i++) {
                    var selectElement = document.getElementById("mem" + i);
                    selectElement.selectedIndex = 0; // Reset to the first option
                }
            }
        }

        function createMemoryOptions() {
            const opcodes = [
                '!', '+', '-', '>R', '@', 'AND', 'DROP', 'DUP', 'OR', 'OVER', 'R>', 'SWAP', 'XOR', 'IF', 'CALL', 'EXIT', 'LIT', 'HALT'
            ];
            let options = opcodes.map((op, i) => `<option value="opcode${i}">${op}</option>`).join('');

            for (let i = -32; i <= -1; i++) {
                let hexValue = (0x10000 + i).toString(16).toUpperCase();
                options += `<option value="${hexValue}">x${hexValue} (${i})</option>`;
            }

            for (let i = 0; i < 128; i++) {
                let value = i.toString(16).padStart(2, '0').toUpperCase();
                let hex = `x00${value}`;
                let description = `(+${i})`;
                options += `<option value="${value}">${hex} ${description}</option>`;
            }

            const masks = ['FFFF', '8888', '8880', 'FFF0', '8800', 'FF00', '8000', 'F000'];
            options += masks.map(mask => `<option value="${mask}">x${mask} (mask)</option>`).join('');

            return options;
        }

        function createMemorySelect(index, options) {
            return `<select id="mem${index}">${options}</select>`;
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        async function createTableRows(numRows) {
            let fragment = document.createDocumentFragment();
            let memoryOptions = createMemoryOptions();

            for (let i = 0; i < numRows; i++) {
                if (i % 10 === 0) {
                    await sleep(0);
                }

                let hexValue = i.toString(16).toUpperCase().padStart(2, '0');
                let tr = document.createElement('tr');
                tr.insertAdjacentHTML('beforeend', `<td align="center" width="35px"><span id="pc${i}">${i === 0 ? 'x' : '&nbsp;'}</span></td>
                    <td align="center" width="78px">x${hexValue}</td>
                    <td align="center" width="110px">${createMemorySelect(i, memoryOptions)}</td>`);
                fragment.appendChild(tr);
            }
            return fragment;
        }

        function createStackRows(numRows, idPrefix) {
            let fragment = document.createDocumentFragment();
            for (let i = 0; i < numRows; i++) {
                let tr = document.createElement('tr');
                tr.insertAdjacentHTML('beforeend', `<td align="center"><span id="${idPrefix}${i}">&nbsp;</span></td>`);
                fragment.appendChild(tr);
            }
            return fragment;
        }

        async function updateTableRows() {
            const rowCountInput = document.getElementById("row-count-input");
            const tableBody = document.getElementById("table-body");
            const dataStackBody = document.getElementById("data-stack-body");
            const returnStackBody = document.getElementById("return-stack-body");

            let numRows = parseInt(rowCountInput.value) || ds;
            numRows = Math.max(5, Math.min(numRows, rowCountInput.max));

            rowCountInput.value = numRows;

            tableBody.innerHTML = '';
            tableBody.appendChild(await createTableRows(numRows));
            dataStackBody.innerHTML = '';
            dataStackBody.appendChild(createStackRows(numRows, 'ds'));
            returnStackBody.innerHTML = '';
            returnStackBody.appendChild(createStackRows(numRows, 'rs'));

            loadMemoryOptions(numRows); // Load the saved memory options

            Reset();
        }

        function saveMemoryOptions() {
            const rowCountInput = document.getElementById("row-count-input");
            let numRows = parseInt(rowCountInput.value) || ds;

            let memoryOptionsData = [];

            for (let i = 0; i < numRows; i++) {
                let selectElement = document.getElementById("mem" + i);
                let selectedIndex = selectElement.selectedIndex;

                memoryOptionsData.push(selectedIndex);
            }

            localStorage.setItem("memoryOptionsData", JSON.stringify(memoryOptionsData));

            alert("Memory options saved");
        }
        function loadMemoryOptions(numRows) {
            let memoryOptionsData = JSON.parse(localStorage.getItem("memoryOptionsData"));

            if (memoryOptionsData !== null) {
                for (let i = 0; i < numRows; i++) {
                    let selectElement = document.getElementById("mem" + i);
                    let selectedIndex = memoryOptionsData[i];

                    if (selectedIndex !== undefined) {
                        selectElement.selectedIndex = selectedIndex;
                    }
                }
            }
        }

        document.addEventListener("DOMContentLoaded", async () => {
            const tableBody = document.getElementById("table-body");
            const dataStackBody = document.getElementById("data-stack-body");
            const returnStackBody = document.getElementById("return-stack-body");

            tableBody.innerHTML = '';
            tableBody.appendChild(await createTableRows(ds));
            dataStackBody.innerHTML = '';
            dataStackBody.appendChild(createStackRows(ds, 'ds'));
            returnStackBody.innerHTML = '';
            returnStackBody.appendChild(createStackRows(ds, 'rs'));

            // Add the Save button event listener
            const saveButton = document.getElementById("save-button");
            saveButton.addEventListener("click", saveMemoryOptions);

            await updateTableRows();
            // Reset();
        });

    </script>
</head>

<body>
    <style>
        .scrollable {
            overflow-y: scroll;
            height: 75vh;
        }

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        table {
            border-collapse: collapse;
        }

        tr:nth-child(odd) {
            background-color: #f2f2f2;
        }
    </style>


    <b>Stack CPU Simulator (16-bit)</b><br><br>
    <input type="button" id="step-but" value=" Step " onclick="Step()">
    <input type="button" id="run-but" value=" Run " onclick="Run()">
    <input type="button" id="stop-but" value=" Stop " onclick="Stop()">
    <input type="button" id="reset-but" value=" Reset " onclick="Reset()">
    <input type="button" id="clear-but" value=" Reset and Clear Memory " onclick="ResetAndClearMem()">
    <button id="save-button">Save</button>
    Number of Address (5-256): <input type="number" id="row-count-input" value="64" min="5" max="256">
    <input type="button" id="appply-but" value="Apply" onclick="updateTableRows()">
    <br><br>
    <div style="display: flex;">
        <div style="padding-right: 0.5vw;">
            <table border="1" cellspacing="1" cellpadding="5" bordercolor="black"
                style="position: sticky; top: 0; width: 100%;">
                <tr>
                    <td align="center" style="width:22px;">PC</td>
                    <td align="center" style="width:51px;">Address</td>
                    <td align="center" style="width:76px;">Memory</td>
                </tr>
            </table>
            <div class="scrollable">
                <table border="1" cellspacing="1" cellpadding="5" bordercolor="black" style="width: 100%;">
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
        <div>
            <table border="1" cellspacing="1" cellpadding="5" bordercolor="black"
                style="position: sticky; top: 0; width: 100%;">
                <tr>
                    <td align="center" style="width: 100%;">Data Stack</td>
                </tr>
            </table>
            <div class="scrollable">
                <table border="1" cellspacing="1" cellpadding="5" bordercolor="black" style="width: 100%;">
                    <tbody id="data-stack-body"></tbody>
                </table>
            </div>
        </div>
        <div>
            <table border="1" cellspacing="1" cellpadding="5" bordercolor="black"
                style="position: sticky; top: 1; width: 100%;">
                <tr>
                    <td align="center" style="width: 100%;">Return Stack</td>
                </tr>
            </table>
            <div class="scrollable">
                <table border="1" cellspacing="1" cellpadding="5" bordercolor="black" style="width: 100%;">
                    <tbody id="return-stack-body"></tbody>
                </table>
            </div>
        </div>
    </div>
    <p style="float: right;">Source code : <a href="https://github.com/ExitedState/Stack-CPU-Simulator/tree/16-bit"
            target="_blank">GitHub</a></p>

</body>

</html>