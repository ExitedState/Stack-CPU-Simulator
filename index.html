<html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=Windows-874">
	<title>Stack CPU Simulator (16-bit)</title>
	<script language="javascript">
		var pc = 0;
		var ds = 64;
		var rs = 64;
		function Step() {
			// fetch
			var ir = document.getElementById("mem" + pc).value;
			var operand = "";

			document.getElementById("pc" + pc).innerHTML = "&nbsp;";
			pc = (parseInt(pc) + 1) % ds;
			document.getElementById("pc" + pc).innerHTML = "x";

			if (ir == "opcode13" || ir == "opcode14" || ir == "opcode16") { // IF, CALL, LIT

				operand = document.getElementById("mem" + pc).value;
				document.getElementById("pc" + pc).innerHTML = "&nbsp;";
				pc = (parseInt(pc) + 1) % ds;
				document.getElementById("pc" + pc).innerHTML = "x";
			}
			// execute
			if (ir == "opcode0") { 				// !

				addr = parseInt(document.getElementById("ds" + ds).innerHTML, 16);
				document.getElementById("ds" + ds).innerHTML = "&nbsp;";
				ds = parseInt(ds) + 1;

				n1 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);
				document.getElementById("ds" + ds).innerHTML = "&nbsp;";
				ds = parseInt(ds) + 1;
				n1 = n1.toString(16).toUpperCase();
				document.getElementById("mem" + addr).value = n1.length == 1 ? "0" + n1 : n1;
				console.log("mem[" + addr + "] = " + (n1.toString(16)).toUpperCase());

			} else if (ir == "opcode1") {		// +

				n2 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);
				document.getElementById("ds" + ds).innerHTML = "&nbsp;";
				ds = parseInt(ds) + 1;

				n1 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);
				tmp = ((n1 + n2) & 0xffff).toString(16).toUpperCase();
				while (tmp.length < 4) tmp = "0" + tmp;
				document.getElementById("ds" + ds).innerHTML = tmp;

			} else if (ir == "opcode2") {		// -

				n2 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);
				document.getElementById("ds" + ds).innerHTML = "&nbsp;";
				ds = parseInt(ds) + 1;

				n1 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);
				tmp = ((n1 + ~n2 + 1) & 0xffff).toString(16).toUpperCase();
				while (tmp.length < 4) tmp = "0" + tmp;
				document.getElementById("ds" + ds).innerHTML = tmp;

			} else if (ir == "opcode3") {		// >R

				rs = parseInt(rs) - 1;
				document.getElementById("rs" + rs).innerHTML = document.getElementById("ds" + ds).innerHTML;
				document.getElementById("ds" + ds).innerHTML = "&nbsp;";
				ds = parseInt(ds) + 1;

			} else if (ir == "opcode4") {		// @

				addr = parseInt(document.getElementById("ds" + ds).innerHTML, 16);
				tmp = document.getElementById("mem" + addr).value;
				while (tmp.length < 4) tmp = "0" + tmp;
				document.getElementById("ds" + ds).innerHTML = tmp;

			} else if (ir == "opcode5") {		// AND

				n2 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);
				document.getElementById("ds" + ds).innerHTML = "&nbsp;";
				ds = parseInt(ds) + 1;

				n1 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);

				tmp = ((n1 & n2) & 0xffff).toString(16).toUpperCase();
				while (tmp.length < 4) tmp = "0" + tmp;
				document.getElementById("ds" + ds).innerHTML = tmp;

			} else if (ir == "opcode6") {		// DROP

				document.getElementById("ds" + ds).innerHTML = "&nbsp;";
				ds = parseInt(ds) + 1;

			} else if (ir == "opcode7") {		// DUP

				document.getElementById("ds" + (ds - 1)).innerHTML = document.getElementById("ds" + ds).innerHTML;
				ds = parseInt(ds) - 1;

			} else if (ir == "opcode8") {		// OR

				n2 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);
				document.getElementById("ds" + ds).innerHTML = "&nbsp;";
				ds = parseInt(ds) + 1;

				n1 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);

				tmp = ((n1 | n2) & 0xffff).toString(16).toUpperCase();
				while (tmp.length < 4) tmp = "0" + tmp;
				document.getElementById("ds" + ds).innerHTML = tmp;

			} else if (ir == "opcode9") {		// OVER

				document.getElementById("ds" + (ds - 1)).innerHTML = document.getElementById("ds" + (ds + 1)).innerHTML;
				ds = parseInt(ds) - 1;

			} else if (ir == "opcode10") {		// R>

				ds = parseInt(ds) - 1;
				document.getElementById("ds" + ds).innerHTML = document.getElementById("rs" + rs).innerHTML;
				document.getElementById("rs" + rs).innerHTML = "&nbsp;";
				rs = parseInt(rs) + 1;

			} else if (ir == "opcode11") {		// SWAP

				n1 = document.getElementById("ds" + ds).innerHTML;
				n2 = document.getElementById("ds" + (ds + 1)).innerHTML;
				document.getElementById("ds" + ds).innerHTML = n2;
				document.getElementById("ds" + (ds + 1)).innerHTML = n1;

			} else if (ir == "opcode12") {		// XOR

				n2 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);
				document.getElementById("ds" + ds).innerHTML = "&nbsp;";
				ds = parseInt(ds) + 1;

				n1 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);

				tmp = ((n1 ^ n2) & 0xffff).toString(16).toUpperCase();
				while (tmp.length < 4) tmp = "0" + tmp;
				document.getElementById("ds" + ds).innerHTML = tmp;

			} else if (ir == "opcode13") {		// IF

				n1 = parseInt(document.getElementById("ds" + ds).innerHTML, 16);
				document.getElementById("ds" + ds).innerHTML = "&nbsp;";
				ds = parseInt(ds) + 1;

				if (n1 == 0) {
					document.getElementById("pc" + pc).innerHTML = "&nbsp;";
					pc = parseInt(operand, 16);
					document.getElementById("pc" + pc).innerHTML = "x";
				}

			} else if (ir == "opcode14") {		// CALL

				rs = parseInt(rs) - 1;
				tmp = pc.toString(16);
				while (tmp.length < 4) tmp = "0" + tmp;
				document.getElementById("rs" + rs).innerHTML = tmp;
				document.getElementById("pc" + pc).innerHTML = "&nbsp;";
				pc = parseInt(operand, 16);
				document.getElementById("pc" + pc).innerHTML = "x";

			} else if (ir == "opcode15") {		// EXIT

				document.getElementById("pc" + pc).innerHTML = "&nbsp;";
				pc = parseInt(document.getElementById("rs" + rs).innerHTML, 16);
				document.getElementById("pc" + pc).innerHTML = "x";
				document.getElementById("rs" + rs).innerHTML = "&nbsp;";
				rs = parseInt(rs) + 1;

			} else if (ir == "opcode16") {		// LIT

				ds = parseInt(ds) - 1;
				tmp = parseInt(operand, 16).toString(16).toUpperCase();
				while (tmp.length < 4) tmp = "0" + tmp;
				document.getElementById("ds" + ds).innerHTML = tmp;

			} else if (ir == "opcode17") {		// HALT

				alert("Halt");

			} else {

				tmp = (pc - 1).toString(16).toUpperCase();
				while (tmp.length < 4) tmp = "0" + tmp;
				alert("Opcode is not found at address " + tmp);
			}
		}

		function Reset() {
			pc = 0;
			ds = 64;
			rs = 64;
			for (var i = 0; i < ds; i++) {
				document.getElementById("pc" + i).innerHTML = "&nbsp;";
				document.getElementById("ds" + i).innerHTML = "&nbsp;";
				document.getElementById("rs" + i).innerHTML = "&nbsp;";
			}
			document.getElementById("pc0").innerHTML = "x";
		}
		function ResetAndClearMem() {
			var confirmation = confirm("Are you sure you want to reset the memory?");
			if (confirmation) {
				pc = 0;
				ds = 64;
				rs = 64;
				for (var i = 0; i < ds; i++) {
					var selectElement = document.getElementById("mem" + i);
					selectElement.selectedIndex = 0; // Reset to the first option
				}
			}
		}
	</script>

	<b>Stack CPU Simulator (16-bit)</b><br>
	<br>
	<input type="button" value=" Step " onclick="javascript:Step()">
	<input type="button" value=" Reset " onclick="javascript:Reset()">
	<input type="button" value=" Reset and Clear Memory " onclick="javascript:ResetAndClearMem()">
	<br>
	<table border="1" cellspacing="0" cellpadding="5" bordercolor="black">
		<tr>
			<td align="center">PC</td>
			<td align="center">Address</td>
			<td align="center">Memory</td>
			<td align="center">Data Stack</td>
			<td align="center">Return Stack</td>
		</tr>
		<!-- Generate 64 rows using a loop -->
		<script>
			for (var i = 0; i < ds; i++) {
				var hexValue = i.toString(16).toUpperCase().padStart(2, '0');
				document.write('<tr>');
				document.write('<td align="center"><span id="pc' + i + '">' + (i === 0 ? 'x' : '&nbsp;') + '</span></td>');
				document.write('<td align="center">x' + hexValue + '</td>');
				document.write('<td align="center">');
				document.write('<select id="mem' + i + '">');
				document.write('<option value="opcode0">!</option>');
				document.write('<option value="opcode1">+</option>');
				document.write('<option value="opcode2">-</option>');
				document.write('<option value="opcode3">>R</option>');
				document.write('<option value="opcode4">@</option>');
				document.write('<option value="opcode5">AND</option>');
				document.write('<option value="opcode6">DROP</option>');
				document.write('<option value="opcode7">DUP</option>');
				document.write('<option value="opcode8">OR</option>');
				document.write('<option value="opcode9">OVER</option>');
				document.write('<option value="opcode10">R></option>');
				document.write('<option value="opcode11">SWAP</option>');
				document.write('<option value="opcode12">XOR</option>');
				document.write('<option value="opcode13">IF</option>');
				document.write('<option value="opcode14">CALL</option>');
				document.write('<option value="opcode15">EXIT</option>');
				document.write('<option value="opcode16">LIT</option>');
				document.write('<option value="opcode17">HALT</option>');
				for (let i = -31; i <= -1; i++) {
					let hexValue = (0x10000 + i).toString(16).toUpperCase();
					document.write(`<option value="${hexValue}">x${hexValue} (${i})</option>`);
				}
				const hexValues = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'A', 'B', 'C', 'D', 'E', 'F'];
				for (let i = 0; i < hexValues.length; i++) {
					for (let j = 0; j < hexValues.length; j++) {
						let value = hexValues[i] + hexValues[j];
						let intValue = parseInt(value, 16);
						if (intValue > 63) {
							break;
						}
						let hex = `x00${value}`;
						let description = `(+${intValue})`;
						document.write(`<option value="${value}">${hex} ${description}</option>`);
					}
				}
				document.write('<option value="8000">x8000 (mask)</option>');
				document.write('<option value="000F">x000F (mask)</option>');
				document.write('<option value="00F0">x00F0 (mask)</option>');
				document.write('<option value="00FF">x00FF (mask)</option>');
				document.write('</select>');
				document.write('</td>');
				document.write('<td align="center"><span id="ds' + i + '">&nbsp;</span></td>');
				document.write('<td align="center"><span id="rs' + i + '">&nbsp;</span></td>');
				document.write('</tr>');
			}
		</script>
	</table> <br>
</head>

<body>
	<input type="button" value=" Step " onclick="javascript:Step()">
	<input type="button" value=" Reset " onclick="javascript:Reset()">
	<input type="button" value=" Reset and Clear Memory " onclick="javascript:ResetAndClearMem()">
</body>

</html>